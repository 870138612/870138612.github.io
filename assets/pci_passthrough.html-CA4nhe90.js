import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as l,o as n}from"./app-Bc5PYhac.js";const e={};function t(h,i){return n(),a("div",null,i[0]||(i[0]=[l(`<h2 id="pci直通示例" tabindex="-1"><a class="header-anchor" href="#pci直通示例"><span>PCI直通示例</span></a></h2><p>一些PCI设备提供独占设备能力和共享能力，在使用SR-IOV时，物理设备会被虚拟化为多个PCI设备，虚拟化设备可以分配给不同的主机，在PCI直通的情况下，完整的物理设备只会分配给一个主机。</p><h3 id="计算节点准备" tabindex="-1"><a class="header-anchor" href="#计算节点准备"><span>计算节点准备</span></a></h3><ul><li><p>硬件要求：</p><ul><li>BIOS 启用 VT-d（Intel）或 AMD-Vi（AMD）。</li><li>Linux 内核启用 IOMMU：添加<code>intel_iommu=on</code>或<code>amd_iommu=on</code>到内核参数。</li></ul></li><li><p>验证命令：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dmesg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> iommu</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 检查 IOMMU 是否启用</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lspci</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -v</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">               # 查看 PCI 设备信息及地址（如 0000:41:00.0）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="配置nova-compute" tabindex="-1"><a class="header-anchor" href="#配置nova-compute"><span>配置nova-compute</span></a></h3><ul><li>指定 PCI 设备，定义设备别名：</li></ul><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" data-title="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">[pci]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">alias</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> { </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;vendor_id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;8086&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;product_id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;154d&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;device_type&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;type-PF&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;a1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">passthrough_whitelist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> {</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;vendor_id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;8086&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;product_id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;154d&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>device_type</code>必须指定为<code>type-PF</code>（SR-IOV 父设备）、<code>type-VF</code>（子设备）或<code>type-PCI</code>（非 SR-IOV 设备）。</li></ul><h3 id="配置nova-scheduler" tabindex="-1"><a class="header-anchor" href="#配置nova-scheduler"><span>配置nova-scheduler</span></a></h3><ul><li><p>启用 <code>PciPassthroughFilter</code> 过滤器：</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" data-title="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">[filter_scheduler]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">enabled_filters</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> ...,PciPassthroughFilter</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="配置nova-api" tabindex="-1"><a class="header-anchor" href="#配置nova-api"><span>配置nova-api</span></a></h3><ul><li><p>控制器节点需同步 <code>pci.alias</code> 配置，与计算节点一致：</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" data-title="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">[pci]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">alias</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> { </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;vendor_id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;8086&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;product_id&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;154d&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;device_type&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;type-PF&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;a1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="配置-flavor" tabindex="-1"><a class="header-anchor" href="#配置-flavor"><span>配置 Flavor</span></a></h3><ul><li><p>通过 Flavor 请求 PCI 设备（示例请求 2 个 <code>a1</code> 设备）：</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" data-title="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">openstack flavor set m1.large --property </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;pci_passthrough:alias&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;a1:2&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul><h3 id="高级配置" tabindex="-1"><a class="header-anchor" href="#高级配置"><span>高级配置</span></a></h3><h5 id="pci-numa-亲和策略" tabindex="-1"><a class="header-anchor" href="#pci-numa-亲和策略"><span>PCI-NUMA 亲和策略</span></a></h5><ul><li><p>策略选项：</p><ul><li><code>required</code>：设备必须与实例的 NUMA 节点严格绑定</li><li><code>socket</code>：设备与实例在同一CPU插槽即可</li><li><code>preferred</code>：尽量亲和，但不强制</li><li><code>legacy</code>：默认策略，兼容旧版本行为</li></ul></li><li><p>配置示例：</p><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" data-title="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">openstack flavor set $FLAVOR --property </span><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">pci_numa_affinity_policy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;">preferred</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul><h3 id="验证pci直通" tabindex="-1"><a class="header-anchor" href="#验证pci直通"><span>验证PCI直通</span></a></h3><ul><li>登录实例</li></ul><p>通过SSH或控制台登录实例</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">openstack</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> console</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> url</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> show</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> VM-with-PCI</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 获取控制台 URL</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>检查PCI设备</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lspci</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 列出所有 PCI 设备</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>预期输出</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">00:04.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ethernet</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> controller:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Intel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Corporation</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 82599ES</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10-Gigabit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> SFI/SFP+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Network</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Connection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (rev </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">01</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="常见问题解决" tabindex="-1"><a class="header-anchor" href="#常见问题解决"><span>常见问题解决</span></a></h3><h4 id="问题-1-实例启动失败" tabindex="-1"><a class="header-anchor" href="#问题-1-实例启动失败"><span>问题 1：实例启动失败</span></a></h4><ul><li><p>原因：PCI 设备未正确配置或资源不足。</p></li><li><p>解决：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nova-status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> upgrade</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> check</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 检查 Nova 服务状态</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">openstack</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> hypervisor</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> stats</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> show</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 查看计算节点 PCI 资源池</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="问题-2-设备未出现在实例中" tabindex="-1"><a class="header-anchor" href="#问题-2-设备未出现在实例中"><span>问题 2：设备未出现在实例中</span></a></h4><ul><li><p>原因：驱动未正确绑定或 IOMMU 未启用。</p></li><li><p>解决：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dmesg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> vfio</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 检查 VFIO 驱动绑定状态</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /proc/cmdline</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     # 确认内核参数包含 \`intel_iommu=on\`</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="pcipassthroughfilter" tabindex="-1"><a class="header-anchor" href="#pcipassthroughfilter"><span>PciPassthroughFilter</span></a></h2><p>在<code>nova.conf</code>配置的过滤器的作用：在创建虚拟机时，通过scheduler顺序执行配置的<code>filter</code>中的<code>host_passes</code>过滤符合条件的host并返回</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="python" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> PciPassthroughFilter</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">filters</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BaseHostFilter</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">filters</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CandidateFilterMixin</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 过滤器检查主机是否有足够的PCI设备满足虚拟机的创建请求</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	# BaseHostFilter基础过滤器，用于调度时执行内部的host_passes方法</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # CandidateFilterMixin提供候选资源过滤的功能，支持复杂的资源需求匹配</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  	# 只会在创建的时候执行，重构时不执行</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">    RUN_ON_REBUILD</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> False</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	# host_state：主机的当前状态（如资源使用情况、PCI设备信息）</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # spec_obj：虚拟机的规格请求（如PCI设备需求）</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> host_passes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> host_state</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> spec_obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        pci_requests </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> spec_obj.pci_requests</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        # 如果没有PCI请求，直接放行</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> not</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pci_requests </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">or</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> not</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pci_requests.requests:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> True</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		# 如果主机没有PCI设备信息，则无法满足任何的PCI请求，不符合要求，返回False</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> not</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> host_state.pci_stats:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">            LOG</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">debug</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%(host_state)s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> doesn&#39;t have the required PCI devices&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                      &quot; (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%(requests)s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">)&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      {</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;host_state&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: host_state, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;requests&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: pci_requests})</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> False</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		# 检查每个候选是否满足PCI请求</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        good_candidates </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">filter_candidates</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            host_state,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">           </span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            support_requests比对主机的PCI设备与虚拟机请求（例如数量、vendor_id、product_id）</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            provider_mapping时一个字典，用来记录资源提供者之间的映射关系,例如</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            {</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                # 虚拟功能（VF）的 UUID -&gt; 对应的物理功能（PF）的 UUID</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                &quot;vf_uuid_1&quot;: &quot;pf_uuid_123&quot;,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                &quot;vf_uuid_2&quot;: &quot;pf_uuid_123&quot;,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                ...</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            }</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;&quot;&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            lambda</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> candidate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: host_state.pci_stats.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">support_requests</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                pci_requests.requests, </span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">provider_mapping</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">candidate[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;mappings&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            ),</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        )</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		# 没有符合要求的PCI设备</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> not</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> good_candidates:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">            LOG</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">debug</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%(host_state)s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> doesn&#39;t have the required PCI devices&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                      &quot; (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%(requests)s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">)&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                      {</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;host_state&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: host_state, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;requests&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: pci_requests})</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> False</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> True</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,33)]))}const d=s(e,[["render",t],["__file","pci_passthrough.html.vue"]]),r=JSON.parse('{"path":"/openstack/nova/pci_passthrough.html","title":"PCI直通","lang":"zh-CN","frontmatter":{"title":"PCI直通","star":true,"icon":"page","category":["设备PCI直通","随记"],"tag":["PCI passthrough"],"description":"PCI直通示例 一些PCI设备提供独占设备能力和共享能力，在使用SR-IOV时，物理设备会被虚拟化为多个PCI设备，虚拟化设备可以分配给不同的主机，在PCI直通的情况下，完整的物理设备只会分配给一个主机。 计算节点准备 硬件要求： BIOS 启用 VT-d（Intel）或 AMD-Vi（AMD）。 Linux 内核启用 IOMMU：添加intel_io...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/openstack/nova/pci_passthrough.html"}],["meta",{"property":"og:site_name","content":"Zzz"}],["meta",{"property":"og:title","content":"PCI直通"}],["meta",{"property":"og:description","content":"PCI直通示例 一些PCI设备提供独占设备能力和共享能力，在使用SR-IOV时，物理设备会被虚拟化为多个PCI设备，虚拟化设备可以分配给不同的主机，在PCI直通的情况下，完整的物理设备只会分配给一个主机。 计算节点准备 硬件要求： BIOS 启用 VT-d（Intel）或 AMD-Vi（AMD）。 Linux 内核启用 IOMMU：添加intel_io..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-03-17T09:48:06.000Z"}],["meta",{"property":"article:tag","content":"PCI passthrough"}],["meta",{"property":"article:modified_time","content":"2025-03-17T09:48:06.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"PCI直通\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-03-17T09:48:06.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Zzz\\",\\"url\\":\\"https://ylzhong.top\\"}]}"]]},"headers":[{"level":2,"title":"PCI直通示例","slug":"pci直通示例","link":"#pci直通示例","children":[{"level":3,"title":"计算节点准备","slug":"计算节点准备","link":"#计算节点准备","children":[]},{"level":3,"title":"配置nova-compute","slug":"配置nova-compute","link":"#配置nova-compute","children":[]},{"level":3,"title":"配置nova-scheduler","slug":"配置nova-scheduler","link":"#配置nova-scheduler","children":[]},{"level":3,"title":"配置nova-api","slug":"配置nova-api","link":"#配置nova-api","children":[]},{"level":3,"title":"配置 Flavor","slug":"配置-flavor","link":"#配置-flavor","children":[]},{"level":3,"title":"高级配置","slug":"高级配置","link":"#高级配置","children":[]},{"level":3,"title":"验证PCI直通","slug":"验证pci直通","link":"#验证pci直通","children":[]},{"level":3,"title":"常见问题解决","slug":"常见问题解决","link":"#常见问题解决","children":[]}]},{"level":2,"title":"PciPassthroughFilter","slug":"pcipassthroughfilter","link":"#pcipassthroughfilter","children":[]}],"git":{"createdTime":1742130587000,"updatedTime":1742204886000,"contributors":[{"name":"zyl","email":"870138612@qq.com","commits":6},{"name":"ZYL1210","email":"60984434+870138612@users.noreply.github.com","commits":3}]},"readingTime":{"minutes":3.12,"words":935},"filePathRelative":"openstack/nova/pci_passthrough.md","localizedDate":"2025年3月16日","excerpt":"<h2>PCI直通示例</h2>\\n<p>一些PCI设备提供独占设备能力和共享能力，在使用SR-IOV时，物理设备会被虚拟化为多个PCI设备，虚拟化设备可以分配给不同的主机，在PCI直通的情况下，完整的物理设备只会分配给一个主机。</p>\\n<h3>计算节点准备</h3>\\n<ul>\\n<li>\\n<p>硬件要求：</p>\\n<ul>\\n<li>BIOS 启用 VT-d（Intel）或 AMD-Vi（AMD）。</li>\\n<li>Linux 内核启用 IOMMU：添加<code>intel_iommu=on</code>或<code>amd_iommu=on</code>到内核参数。</li>\\n</ul>\\n</li>\\n<li>\\n<p>验证命令：</p>\\n<div class=\\"language-bash line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"bash\\" data-title=\\"bash\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">dmesg</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\"> | </span><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">grep</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> -i</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> iommu</span><span style=\\"--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">  # 检查 IOMMU 是否启用</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">lspci</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> -v</span><span style=\\"--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic\\">               # 查看 PCI 设备信息及地址（如 0000:41:00.0）</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div></li>\\n</ul>","autoDesc":true}');export{d as comp,r as data};
