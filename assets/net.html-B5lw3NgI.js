import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,d as e,o as n}from"./app-DCDIoS1i.js";const l="/assets/image-20250713184956466-pG3hXZCD.png",p="/assets/image-20250713185230331-Dxd9B6Sb.png",t="/assets/image-20250713185548318-DKHGp7IH.png",d="/assets/image-20250713190434392-CkT6TGju.png",r="/assets/image-20250713190712598-BB69u3dD.png",c="/assets/image-20250713191516775-1752405318189-3-Bq5XNzEv.png",h="/assets/image-20250713192052039-D_AIzVFk.png",g="/assets/image-20250713200653916-C1mgTg8E.png",o="/assets/image-20250713194518954-mE4_RZCG.png",m="/assets/image-20250713194800845-D3eeLHky.png",k="/assets/image-20250713201701029-CK2235ma.png",v="/assets/image-20250713202433955-BVerX50l.png",u={};function b(y,s){return n(),a("div",null,s[0]||(s[0]=[e(`<h2 id="iptables" tabindex="-1"><a class="header-anchor" href="#iptables"><span>iptables</span></a></h2><p>通过配置文件的方式创建nginx Pod</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>apiVersion: v1</span></span>
<span class="line"><span>kind: Deployment</span></span>
<span class="line"><span>metadata:</span></span>
<span class="line"><span>  name: nginx-deployment</span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  selector:</span></span>
<span class="line"><span>    matchLabels:</span></span>
<span class="line"><span>      app: nginx</span></span>
<span class="line"><span>  replicas: 2</span></span>
<span class="line"><span>  template:</span></span>
<span class="line"><span>    metadata:</span></span>
<span class="line"><span>      labels:</span></span>
<span class="line"><span>        app: nginx</span></span>
<span class="line"><span>    spec:</span></span>
<span class="line"><span>      containers:</span></span>
<span class="line"><span>      - name: nginx</span></span>
<span class="line"><span>        image: nginx:latest</span></span>
<span class="line"><span>        ports:</span></span>
<span class="line"><span>        - containerPort: 80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+l+`" alt="image-20250713184956466" tabindex="0" loading="lazy"><figcaption>image-20250713184956466</figcaption></figure><p>再使用刚刚定义的service yaml 创建服务</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">apiVersion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">v1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Service</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">metadata</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ngx-svc</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">spec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  ports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  - </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">http</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    port</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    targetPort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  selector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    app</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">nginx</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ClusterIP</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+p+'" alt="image-20250713185230331" tabindex="0" loading="lazy"><figcaption>image-20250713185230331</figcaption></figure><p>查看后端暴露的Pod地址和端口</p><figure><img src="'+t+'" alt="image-20250713185548318" tabindex="0" loading="lazy"><figcaption>image-20250713185548318</figcaption></figure><p>即是后端服务service对集群的暴露端口为<code>10.103.59.92</code>，当请求这个地址时，会根据<code>iptables</code>策略转发到<code>service</code>上的<code>ENDPOINTS</code>上</p><p>由于使用了Deployment进行部署，所以杀死任何一个nginx的Pod，都会立即再拉起一个Pod，始终保证Pod的数量为2，并且还会为其重新分配地址</p><p>查看KUBE-SERVICES规则</p><figure><img src="'+d+'" alt="image-20250713190434392" tabindex="0" loading="lazy"><figcaption>image-20250713190434392</figcaption></figure><p>当访问ClusterIP:{dpt:80}的时候则会匹配第三条规则，则会跳转到地址 default/ngx-svc:http</p><p>查看规则详情，则发现当目的地为<code>0.0.0.0/0</code>规则的匹配IP和端口的时候，则会跳转到两个PodIP地址的任何一个，匹配规则为随机，第一个概率为50%</p><figure><img src="'+r+'" alt="image-20250713190712598" tabindex="0" loading="lazy"><figcaption>image-20250713190712598</figcaption></figure><p>再选择第一个规则进行查看，发现在规则中实现了DNAT，将ClusterIP地址转化为容器内地址</p><figure><img src="'+c+'" alt="image-20250713191516775" tabindex="0" loading="lazy"><figcaption>image-20250713191516775</figcaption></figure><p>其中KUBE-MARK-MASQ规则是在容器外的网络访问的将流量打上标签，即节点内，容器外</p><figure><img src="'+h+'" alt="image-20250713192052039" tabindex="0" loading="lazy"><figcaption>image-20250713192052039</figcaption></figure><p>在所有的iptables规则集中，找到POSRTROUTING规则</p><figure><img src="'+g+`" alt="image-20250713200653916" tabindex="0" loading="lazy"><figcaption>image-20250713200653916</figcaption></figure><p>其中有一条为<code>MASQUERADE</code>，即是将打标签的流量进行SNAT源地址转换，让流量能原路返回</p><p>在使用ClusterIP类型创建服务时，服务只对集群内暴露，当设置为NodePort时，则会将节点的物理网卡中选择一个Port对其进行访问</p><h2 id="service类型" tabindex="-1"><a class="header-anchor" href="#service类型"><span>Service类型</span></a></h2><h3 id="headless-service" tabindex="-1"><a class="header-anchor" href="#headless-service"><span>Headless Service</span></a></h3><p>通过对Cluter IP设置为&quot;None&quot;，则不会对其分配服务地址，kube-proxy也不会对访问它的流量做iptables规则，这种方式可实现客户端路由，</p><p>当客户端访问服务的时候，进行DNS解析时，会将其包含的所有ENDPOINTS的IP地址进行返回，因此可以实现客户端负载均衡</p><h3 id="externalname-service" tabindex="-1"><a class="header-anchor" href="#externalname-service"><span>ExternalName Service</span></a></h3><p>查找CNAME记录，将服务发现给外部的DNS</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>type: ExternalName</span></span>
<span class="line"><span>externalName: ylzhong.top</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="dns" tabindex="-1"><a class="header-anchor" href="#dns"><span>DNS</span></a></h2><p>Pod和Service都会产生DNS记录</p><p>通过查询Pod可以得知每一个节点的k8sDNS服务IP地址</p><figure><img src="`+o+'" alt="image-20250713194518954" tabindex="0" loading="lazy"><figcaption>image-20250713194518954</figcaption></figure><p>查询当中一个nginx Pod的域名解析记录</p><figure><img src="'+m+`" alt="image-20250713194800845" tabindex="0" loading="lazy"><figcaption>image-20250713194800845</figcaption></figure><p>当ClusterIP设置为None的时候，Service生成的DNS记录</p><div class="language-toml line-numbers-mode" data-highlighter="shiki" data-ext="toml" data-title="toml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">ngx-svc.default.svc.cluster.local.4 IN A 10.103.59.91</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果设置为None，则生成的DNS记录</p><div class="language-toml line-numbers-mode" data-highlighter="shiki" data-ext="toml" data-title="toml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">ngx-svc.default.svc.cluster.local.4 IN A 10.244.104.29.80</span></span>
<span class="line"><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">ngx-svc.default.svc.cluster.local.4 IN A 10.244.166.157.80</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果设置为External，则生成DNS记录</p><div class="language-toml line-numbers-mode" data-highlighter="shiki" data-ext="toml" data-title="toml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">ngx-svc.default.svc.cluster.local.10 IN CNAME www.ylzhong.top</span></span>
<span class="line"><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">ylzhong.top 28715 IN A 192.168.100.100</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>同样，如果想自定义解析方式，则可以修改<code>vim /etc/resolv.conf</code></p><div class="language-conf line-numbers-mode" data-highlighter="shiki" data-ext="conf" data-title="conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># Generated by NetworkManager</span></span>
<span class="line"><span>nameserver 114.114.114.114</span></span>
<span class="line"><span>nameserver 8.8.8.8</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="calico" tabindex="-1"><a class="header-anchor" href="#calico"><span>calico</span></a></h2><p>介绍组件作用</p><p>在master上执行</p><figure><img src="`+k+'" alt="image-20250713201701029" tabindex="0" loading="lazy"><figcaption>image-20250713201701029</figcaption></figure><p>可见master节点与其他两个节点建立了隧道，</p><p>主机网络的流量会从物理网卡出去</p><p>对于从节点来说，对每一个Pod都会创建一个虚拟网卡与caliconode进行连接</p><figure><img src="'+v+'" alt="image-20250713202433955" tabindex="0" loading="lazy"><figcaption>image-20250713202433955</figcaption></figure>',53)]))}const F=i(u,[["render",b],["__file","net.html.vue"]]),x=JSON.parse('{"path":"/k8s/net.html","title":"","lang":"zh-CN","frontmatter":{"description":"iptables 通过配置文件的方式创建nginx Pod image-20250713184956466image-20250713184956466 再使用刚刚定义的service yaml 创建服务 image-20250713185230331image-20250713185230331 查看后端暴露的Pod地址和端口 image-20250...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/k8s/net.html"}],["meta",{"property":"og:site_name","content":"Zzz"}],["meta",{"property":"og:description","content":"iptables 通过配置文件的方式创建nginx Pod image-20250713184956466image-20250713184956466 再使用刚刚定义的service yaml 创建服务 image-20250713185230331image-20250713185230331 查看后端暴露的Pod地址和端口 image-20250..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-07-13T12:24:58.000Z"}],["meta",{"property":"article:modified_time","content":"2025-07-13T12:24:58.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-07-13T12:24:58.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Zzz\\",\\"url\\":\\"https://ylzhong.top\\"}]}"]]},"headers":[{"level":2,"title":"iptables","slug":"iptables","link":"#iptables","children":[]},{"level":2,"title":"Service类型","slug":"service类型","link":"#service类型","children":[{"level":3,"title":"Headless Service","slug":"headless-service","link":"#headless-service","children":[]},{"level":3,"title":"ExternalName Service","slug":"externalname-service","link":"#externalname-service","children":[]}]},{"level":2,"title":"DNS","slug":"dns","link":"#dns","children":[]},{"level":2,"title":"calico","slug":"calico","link":"#calico","children":[]}],"git":{"createdTime":1752409498000,"updatedTime":1752409498000,"contributors":[{"name":"ZYL1210","email":"870138612@qq.com","commits":1}]},"readingTime":{"minutes":2.74,"words":821},"filePathRelative":"k8s/net.md","localizedDate":"2025年7月13日","excerpt":"<h2>iptables</h2>\\n<p>通过配置文件的方式创建nginx Pod</p>\\n<div class=\\"language- line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"\\" data-title=\\"\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code><span class=\\"line\\"><span>apiVersion: v1</span></span>\\n<span class=\\"line\\"><span>kind: Deployment</span></span>\\n<span class=\\"line\\"><span>metadata:</span></span>\\n<span class=\\"line\\"><span>  name: nginx-deployment</span></span>\\n<span class=\\"line\\"><span>spec:</span></span>\\n<span class=\\"line\\"><span>  selector:</span></span>\\n<span class=\\"line\\"><span>    matchLabels:</span></span>\\n<span class=\\"line\\"><span>      app: nginx</span></span>\\n<span class=\\"line\\"><span>  replicas: 2</span></span>\\n<span class=\\"line\\"><span>  template:</span></span>\\n<span class=\\"line\\"><span>    metadata:</span></span>\\n<span class=\\"line\\"><span>      labels:</span></span>\\n<span class=\\"line\\"><span>        app: nginx</span></span>\\n<span class=\\"line\\"><span>    spec:</span></span>\\n<span class=\\"line\\"><span>      containers:</span></span>\\n<span class=\\"line\\"><span>      - name: nginx</span></span>\\n<span class=\\"line\\"><span>        image: nginx:latest</span></span>\\n<span class=\\"line\\"><span>        ports:</span></span>\\n<span class=\\"line\\"><span>        - containerPort: 80</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{F as comp,x as data};
